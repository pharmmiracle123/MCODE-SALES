<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expiry Product | Inventory Control</title>

<script>
tailwind = {
  config: {
    theme: {
      extend: {
        colors: { 
          primary: '#16a34a', // green
          primaryLight: '#d1fae5',
          bgGradientStart: '#e6f5ec',
          bgGradientEnd: '#d1fae5'
        }
      }
    }
  }
}
</script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
  font-family: system-ui, -apple-system;
  background: linear-gradient(135deg, #e6f5ec 0%, #d1fae5 100%);
}

header {
  background: linear-gradient(to right, #b91c1c, #f87171); /* red header gradient */
  color: white;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

header h1 {
  text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
}

header p {
  color: #ffe4e6;
}

.bin-card {
  transition: transform 0.2s, box-shadow 0.2s;
}

.bin-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.bin-card.handled {
  opacity: 0.6;
}

input, button {
  transition: all 0.2s;
}

input:focus {
  outline: none;
  border-color: #b91c1c;      /* deep red */
  background-color: #fff0f0;  /* very light red/white effect */
  box-shadow: 0 0 8px rgba(185,28,28,0.5); /* subtle red glow */
}

button:hover {
  opacity: 0.9;
}

/* PRINT STYLES */
@media print {
  header, .no-print { display: none !important; }
  body { background: white; }
  .bin-card { page-break-inside: avoid; border: 1px solid #000; }
}
</style>
</head>
<body class="min-h-screen">

<header class="border-b py-5">
  <div class="max-w-7xl mx-auto px-6 flex justify-between items-center">
    <div>
      <h1 class="text-2xl md:text-3xl font-bold">EXPIRY BIN CARD REGISTER</h1>
      <p class="text-sm md:text-base mt-1">Inventory Expiry Monitoring</p>
    </div>
    <div class="flex gap-3 items-center no-print">
      <button onclick="window.print()" class="bg-green-600 text-white px-4 py-2 rounded shadow font-semibold hover:bg-green-700">
        Print
      </button>
      <a href="index.html" class="underline text-white font-medium hover:text-gray-100">Dashboard</a>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-6 py-8">

<!-- FORM -->
<section class="bg-white border rounded-xl mb-6 shadow-lg p-5 no-print">
  <div class="border-b border-gray-200 pb-3 mb-3">
    <h2 class="text-xl font-bold text-green-700">Record New Product</h2>
    <p class="text-sm text-gray-500">Enter product details as labeled</p>
  </div>

  <form id="binForm" class="grid grid-cols-1 md:grid-cols-5 gap-4">
    <input id="name" required placeholder="Product Name" class="border px-3 py-2 rounded text-sm shadow-sm">
    <input id="qty" type="number" required placeholder="Qty" class="border px-3 py-2 rounded text-sm shadow-sm">
    <input id="batch" placeholder="Batch No" class="border px-3 py-2 rounded text-sm shadow-sm">
    <input id="expiry" type="date" required class="border px-3 py-2 rounded text-sm shadow-sm">
    <button type="submit" class="bg-green-600 text-white rounded text-sm font-semibold shadow hover:bg-green-700">
      Save Record
    </button>
  </form>
  <p id="successMsg" class="text-green-600 text-sm mt-2 hidden">âœ… Product added successfully!</p>
</section>

<!-- SEARCH -->
<section class="mb-6">
  <input type="text" id="searchInput" placeholder="Search products..." class="w-full border px-3 py-2 rounded text-sm shadow-sm focus:ring-1 focus:ring-green-600">
</section>

<!-- STATS -->
<section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-center">
  <div class="bg-white border rounded-xl p-6 shadow hover:scale-105 transition-transform">
    <p class="text-xs text-gray-500">TOTAL ITEMS</p>
    <p id="totalProducts" class="text-3xl font-bold text-green-700">0</p>
  </div>
  <div class="bg-yellow-50 border border-yellow-300 rounded-xl p-6 shadow hover:scale-105 transition-transform">
    <p class="text-xs">NEAR EXPIRY</p>
    <p id="nearExpiry" class="text-3xl font-bold text-yellow-700">0</p>
  </div>
  <div class="bg-red-50 border border-red-300 rounded-xl p-6 shadow hover:scale-105 transition-transform">
    <p class="text-xs">EXPIRED</p>
    <p id="expired" class="text-3xl font-bold text-red-700">0</p>
  </div>
</section>

<!-- BIN CARDS -->
<section>
  <h2 class="text-xl font-bold mb-4 text-green-700">Bin Card Records</h2>
  <div id="cards" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
  <div id="empty" class="text-center py-12 text-gray-500 hidden">
    No near-expiry or expired products
  </div>
  <label class="text-sm font-semibold">Near expiry threshold (days)</label>
  <input type="number" id="nearDaysInput" value="7" class="border px-2 py-1 rounded text-sm">
</section>

</main>

<audio id="alertSound">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* ====== FIREBASE CONFIG ====== */
const firebaseConfig = {
  apiKey: "AIzaSyDC49oGcE3EAXSjjJ1mstpowbpjaaY8PTc",
  authDomain: "mcode-sales.firebaseapp.com",
  databaseURL: "https://mcode-sales-default-rtdb.firebaseio.com",
  projectId: "mcode-sales",
  storageBucket: "mcode-sales.appspot.com",
  messagingSenderId: "823876737976",
  appId: "1:823876737976:web:45245a0fef4f5094dd0d4d"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* ====== ELEMENTS ====== */
const binForm = document.getElementById("binForm");
const nameInput = document.getElementById("name");
const qtyInput = document.getElementById("qty");
const batchInput = document.getElementById("batch");
const expiryInput = document.getElementById("expiry");
const successMsg = document.getElementById("successMsg");
const cards = document.getElementById("cards");
const empty = document.getElementById("empty");
const totalEl = document.getElementById("totalProducts");
const nearEl = document.getElementById("nearExpiry");
const expiredEl = document.getElementById("expired");
const alertSound = document.getElementById("alertSound");
const searchInput = document.getElementById("searchInput");
const nearDaysInput = document.getElementById("nearDaysInput");

let currentUser = null;
let productsRef = null;
let thresholdRef = null;
let alertPlayed = false; 
const role = localStorage.getItem("role") || "user";

/* ====== INIT PAGE ====== */
function initPageForUser(user){
  if(!user) return;
  currentUser = user;
  const uid = user.uid;
  productsRef = ref(db, `users/${uid}/expiryProducts`);
  thresholdRef = ref(db, `users/${uid}/settings/thresholdDays`);

  // Load threshold from Firebase
  onValue(thresholdRef, snap => {
    const val = snap.val();
    if(val && val.value !== undefined){
      nearDaysInput.value = val.value;
      localStorage.setItem("nearExpiryDays", val.value);
    } else {
      nearDaysInput.value = localStorage.getItem("nearExpiryDays") || 7;
    }
    loadBinCards();
  });

  loadBinCards();
}

/* ====== AUTH STATE ====== */
onAuthStateChanged(auth, user => {
  if(user){
    initPageForUser(user);
  } else {
    alert("You must be signed in to access this page.");
    window.location.href = "firebase login.html";
  }
});

/* ====== SAVE PRODUCT ====== */
binForm.addEventListener("submit", async e => {
  e.preventDefault();
  if(!productsRef || !currentUser) return alert("User not authenticated yet.");

  const data = {
    name: nameInput.value,
    qty: Number(qtyInput.value),
    batch: batchInput.value || "-",
    expiry: expiryInput.value,
    handled: false
  };

  try {
    await push(productsRef, data);
    binForm.reset();
    successMsg.classList.remove("hidden");
    setTimeout(()=>successMsg.classList.add("hidden"), 3000);
  } catch(err){
    alert("Error saving record: "+err);
  }
});

/* ====== THRESHOLD INPUT ====== */
nearDaysInput.addEventListener("input", () => {
  const val = Number(nearDaysInput.value) || 7;
  localStorage.setItem("nearExpiryDays", val);

  if(thresholdRef && currentUser){
    // Must pass object
    update(thresholdRef, { value: val });
  }

  loadBinCards();
});

/* ====== LOAD BIN CARDS ====== */
function loadBinCards(){
  if(!productsRef) return;
  onValue(productsRef, snap => {
    const filterText = searchInput.value.toLowerCase();
    cards.innerHTML = "";
    let total=0, near=0, expired=0;
    const today = new Date(); today.setHours(0,0,0,0);

    const NEAR_EXPIRY_DAYS = Number(nearDaysInput.value) || 7;

    if(!snap.exists()){ empty.classList.remove("hidden"); return; }
    empty.classList.add("hidden");

    snap.forEach(child => {
      const p = child.val(), id = child.key;

      if(filterText && !p.name.toLowerCase().includes(filterText)) return;

      total++;
      const exp = new Date(p.expiry); exp.setHours(0,0,0,0);
      const diff = Math.ceil((exp - today)/(1000*60*60*24));

      let status="OK", color="border-gray-300";
      if(diff < 0){ status="EXPIRED"; color="border-red-500"; expired++; }
      else if(diff <= NEAR_EXPIRY_DAYS){ status="NEAR EXPIRY"; color="border-yellow-500"; near++; }

      const card = document.createElement("div");
      card.className = `bin-card bg-white border-l-4 ${color} p-5 rounded shadow ${p.handled ? "handled" : ""}`;
      card.innerHTML = `
        <table class="w-full text-sm">
          <tr><td class="font-semibold">Product</td><td>${p.name}</td></tr>
          <tr><td class="font-semibold">Qty</td><td>${p.qty}</td></tr>
          <tr><td class="font-semibold">Batch</td><td>${p.batch}</td></tr>
          <tr><td class="font-semibold">Expiry</td><td>${p.expiry}</td></tr>
          <tr><td class="font-semibold">Status</td><td class="font-bold">${status}</td></tr>
        </table>
      `;

      const actions = document.createElement("div");
      actions.className="mt-4 grid grid-cols-3 gap-2 no-print";

      const editBtn = document.createElement("button");
      editBtn.className="border py-1 rounded text-sm";
      editBtn.textContent="Edit";
      editBtn.addEventListener("click", ()=>{
        const newName = prompt("New Product Name", p.name) || p.name;
        const newQty = Number(prompt("New quantity", p.qty)) || p.qty;
        const newBatch = prompt("New batch", p.batch) || p.batch;
        const newExp = prompt("New expiry YYYY-MM-DD", p.expiry) || p.expiry;

        update(ref(db, `users/${currentUser.uid}/expiryProducts/${id}`), {
          name: newName,
          qty: newQty,
          batch: newBatch,
          expiry: newExp,
          handled: false
        });
      });

      const markBtn = document.createElement("button");
      markBtn.className="bg-green-600 text-white py-1 rounded text-sm";
      markBtn.textContent = p.handled ? "Unmark" : "Mark Handled";
      markBtn.addEventListener("click", ()=>{
        update(ref(db, `users/${currentUser.uid}/expiryProducts/${id}`), {handled: !p.handled});
      });

      const deleteBtn = document.createElement("button");
      deleteBtn.className="bg-red-700 text-white py-1 rounded text-sm";
      deleteBtn.textContent = "Delete";
      deleteBtn.addEventListener("click", ()=>{
        if(confirm("Are you sure you want to delete this product?"))
          remove(ref(db, `users/${currentUser.uid}/expiryProducts/${id}`));
      });

      actions.appendChild(editBtn);
      actions.appendChild(markBtn);
      actions.appendChild(deleteBtn);
      card.appendChild(actions);

      cards.appendChild(card);
    });

    totalEl.textContent = total;
    nearEl.textContent = near;
    expiredEl.textContent = expired;

    if(!alertPlayed && (near + expired > 0)){
      alertSound.play().catch(()=>{});
      alertPlayed = true;
    }
  });
}

/* ====== SEARCH FILTER ====== */
searchInput.addEventListener("input", loadBinCards);
</script>

</body>
</html>
